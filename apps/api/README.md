# PCGL DACO API

Node.js Express API for the Pan-Canadian Genome Library's Data Access Compliance Office.

This app uses features from Node ^20.9, in combination with TSX for TypeScript support, and it provides access to a Postgres database using Drizzle ORM.

## Local Development

The easiest way to run the DACO UI is by following the [general setup instructions from the workspace README](../../README.md#setup).

To run the DACO API requires a Postgres database connection. The workspace's docker-compose provides a Postgres container that is pre-configured to work with the default [environment variables](#environment-variables).

Follow these steps to prepare your local machine to run this application from source:

1. Install all npm dependencies: `pnpm i`
2. Run Docker dependencies. From the root of this workspace: `docker-compose up -d`
3. Initialize this repository: `pnpm setup`
   1. Creates a `.env` and `.env.clinical` file with default values. Update the values in this file if you need to change the application configuration.
   2. Runs migrations to setup database
4. Start application: `pnpm dev`

## Environment Variables

DACO requires multiple services to be running to be used like clinical-submission. Clinical-Submission requires their own set of environment variables, many of the environment variable share similar names, so we utilize two different env files like the following `.env` and `.env.clinical`. In our docker-compose file, when we launch clinical-submission, it will look at the `.env.clinical` environment variables. 

The following sub-sections list the environment variables that can be set to configure the DACO API. If the property is listed as required, the app will fail to run without a value being provided to the server's runtime environment.

### Environment Variables DACO



| Name                 | Description                                                                                                                                                                                                                                                                                                                                | Type      | Required                                  | Default    |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------- | ----------------------------------------- | ---------- |
| `PORT`               | Port number this service will listen to.                                                                                                                                                                                                                                                                                                   | `number`  | Optional                                  | `3000`     |
|                      |                                                                                                                                                                                                                                                                                                                                            |           |                                           |            |
| `PG_DATABASE`        | Postgres database name.                                                                                                                                                                                                                                                                                                                    | `string`  | Required                                  |            |
| `PG_HOST`            | Postgres database host address.                                                                                                                                                                                                                                                                                                            | `string`  | Required                                  |            |
| `PG_PASSWORD`        | Postgres database password.                                                                                                                                                                                                                                                                                                                | `string`  | Required                                  |            |
| `PG_USER`            | Postgres database user name.                                                                                                                                                                                                                                                                                                               | `string`  | Required                                  |            |
|                      |                                                                                                                                                                                                                                                                                                                                            |           |                                           |            |
| `SESSION_KEYS`       | Secret keys to use to encrypt and validate session tokens. This can be a single key or multiple keys as a **comma separated list**. The first key will be used for encrypting new tokens, the rest can be used to validate existing keys. An array of values can be used to rotate session secrets without invalidating existing sessions. | `string`  | Required                                  |            |
| `SESSION_MAX_AGE`    | Number of miliseconds that a session token will remain active. Must be an integer.                                                                                                                                                                                                                                                         | `number`  | Optional                                  | 30 minutes |
| `VALKEY_PORT`        | Valkey port.                                                                                                                                                                                                                                                                                                                               | `number`  | Required                                  |            |
| `VALKEY_HOST`        | Valkey host address.                                                                                                                                                                                                                                                                                                                       | `string`  | Required                                  |            |
| `VALKEY_PASSWORD`    | Valkey user password.                                                                                                                                                                                                                                                                                                                      | `string`  | Required                                  |            |
| `VALKEY_USER`        | Valkey user name.                                                                                                                                                                                                                                                                                                                          | `string`  | Required                                  |            |
|                      |                                                                          
| `DISABLE_AUTH`       | Set this to `true` to disable auth. Any other value and this will default to auth enabled.                                                                                                                                                                                                                                                 | `boolean` | Optional                                  | `false`    |
| `AUTH_CLIENT_ID`     | Client ID for OIDC Provider registered private client.                                                                                                                                                                                                                                                                                     | `string`  | Conditional <br/> `DISABLE_AUTH !== true` |            |
| `AUTH_CLIENT_SECRET` | Client Secret for OIDC Provider registered private client.                                                                                                                                                                                                                                                                                 | `string`  | Conditional <br/> `DISABLE_AUTH !== true` |            |
| `AUTH_PROVIDER_HOST` | OIDC Provider host URL.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `string`  | Conditional <br/> `DISABLE_AUTH !== true` |            |
| `AUTHZ_ENDPOINT`     | Authorization server endpoint.                                                                                                                                                                                                                                                                                                             | `string`  | Conditional <br/> `DISABLE_AUTH !== true` |            |
| `AUTHZ_GROUP_DACO`   | Authorization group for DACO.                                                                                                                                                                                                                                                                                                              | `string`  | Conditional <br/> `DISABLE_AUTH !== true` |            |
| `AUTHZ_GROUP_DAC_MEMBER` | Authorization group for DAC members.                                                                                                                                                                                                                                                                                                   | `string`  | Conditional <br/> `DISABLE_AUTH !== true` |            |
| `AUTHZ_GROUP_DAC_CHAIR` | Authorization group for DAC chair.                                                                                                                                                                                                                                                                                                      | `string`  | Conditional <br/> `DISABLE_AUTH !== true` |            |
| `PCGL_DACO_ID`       | PCGL DACO ID.                                                                                                                                                                                                                                                                                                                              | `string`  | Optional |            |
| `AUTHZ_GROUP_ADMIN`  | Authorization group for admins.                                                                                                                                                                                                                                                                                                            | `string`  | Conditional <br/> `DISABLE_AUTH !== true`                                  |            |
| `AUTHZ_GROUP_SUBMITTERS` | Authorization group for submitters.                                                                                                                                                                                                                                                                                                    | `string`  | Conditional DISABLE_AUTH !== true |            |
| `AUTHZ_SERVICE_ID`   | Authorization Service ID.                                                                                                                                                                                                                                                                                                                  | `string`  | Conditional <br/> `DISABLE_AUTH !== true` |            |
| `AUTHZ_SERVICE_UUID` | Authorization Service UUID.   | `string` | Conditional <br/> `DISABLE_AUTH !== true`

### Environment Variables Clinical
 Name                        | Description                                                                                                                                                                                                                                                                                                                                                                                                 | Default                                |
| --------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------- |
| `API_HOST`                  | The domain name or URL of the API's host server. (Example: https://www.example.com)                                                                                                                                                                                                                                                                                                                         |                                        |
| `ALLOWED_ORIGINS`           | Specifies a list of permitted origins for Cross-Origin Resource Sharing (CORS). These origins, separated by commas, are allowed to make requests to the server, ensuring only trusted domains can access resources. (Example: https://www.example.com,https://subdomain.example.com)                                                                                                                        |                                        |
| `AUDIT_ENABLED`             | Ensures that any modifications to the submitted data are logged, providing a way to identify who made changes and when they were made.                                                                                                                                                                                                                                                                      | true                                   |
| `AUTH_ENABLED`              | Enable authentication middleware.                                                                                                                                                                                                                                                                                                                                                                           | false                                  |
| `AUTH_CLIENT_ID`            | Used to identify the application to the authentication server. Required when `AUTH_ENABLED` is enabled.                                                                                                                                                                                                                                                                                                     |                                        |
| `AUTH_CLIENT_SECRET`        | A secret value used to authenticate the application with the authentication server. Required when `AUTH_ENABLED` is enabled.                                                                                                                                                                                                                                                                                |                                        |
| `AUTH_PROVIDER_HOST`        | The domain or IP address of the authentication server. Required when `AUTH_ENABLED` is enabled.                                                                                                                                                                                                                                                                                                             |                                        |
| `AUTH_PROTECT_METHODS`      | Specifies a list of HTTP methods to protect, separated by commas. (Example: DELETE,GET,POST,PUT).                                                                                                                                                                                                                                                                                                           | 'DELETE,GET,POST,PUT'                  |
| `AUTHZ_ENDPOINT`            | The domain or IP address of the authorization server. Required when `AUTH_ENABLED` is enabled.                                                                                                                                                                                                                                                                                                              |                                        |
| `AUTHZ_GROUP_ADMIN`         | Authorization group configuration for determining admin group                                                                                                                                                                                                                                                                                                                                               |                                        |
| `AUTHZ_SERVICE_ID`         | Authorization Service ID.                                                                                                                                                                                                                                                                                                                                               |                                        |
| `AUTHZ_SERVICE_UUID`         | Authorization Service UUID.                                                                                                                                                                                                                                                                                                                                               |                                        |
| `DB_HOST`                   | Database Hostname                                                                                                                                                                                                                                                                                                                                                                                           |                                        |
| `DB_NAME`                   | Database Name                                                                                                                                                                                                                                                                                                                                                                                               |                                        |
| `DB_PASSWORD`               | Database Password                                                                                                                                                                                                                                                                                                                                                                                           |                                        |
| `DB_PORT`                   | Database Port                                                                                                                                                                                                                                                                                                                                                                                               |                                        |
| `DB_USER`                   | Database User                                                                                                                                                                                                                                                                                                                                                                                               |                                        |
| `ID_CUSTOM_ALPHABET`        | Custom Alphabet for local ID generation                                                                                                                                                                                                                                                                                                                                                                     | '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ' |
| `ID_CUSTOM_SIZE`            | Custom size of ID for local ID generation                                                                                                                                                                                                                                                                                                                                                                   | 21                                     |
| `ID_USELOCAL`               | Generate ID locally                                                                                                                                                                                                                                                                                                                                                                                         | true                                   |
| `ID_MANAGER_CONFIG`         | JSON string containing configuration options for the internal ID generation system. This defines how unique identifiers should be generated for different entities within the system. Example: [{ "entityName": "Participant", "fieldName": "participantId", "prefix": "PT", "paddingLength": 8, "parentEntityName": "Study", "parentFieldName": "studyId" }]                                               |                                        |
| `ID_MANAGER_SECRET`         | A secret value utilized in the hashing process as a salt                                                                                                                                                                                                                                                                                                                                                    |                                        |
| `LECTERN_URL`               | PCGL Dictionary Management (Schema Management) URL                                                                                                                                                                                                                                                                                                                                                          |                                        |
| `LOG_LEVEL`                 | Log Level                                                                                                                                                                                                                                                                                                                                                                                                   | 'info'                                 |
| `PLURALIZE_SCHEMAS_ENABLED` | This feature automatically convert schema names to their plural forms when handling compound documents. Pluralization assumes the words are in English                                                                                                                                                                                                                                                      | true                                   |
| `SERVER_PORT`               | Server Port                                                                                                                                                                                                                                                                                                                                                                                                 | 3030                                   |
| `UPLOAD_LIMIT`              | Limit upload file size in string or number. <br>Supported units and abbreviations are as follows and are case-insensitive: <br> - b for bytes<br> - kb for kilobytes<br>- mb for megabytes<br>- gb for gigabytes<br>- tb for terabytes<br>- pb for petabytes<br>Any other text is considered as byte                                                                                                        | '10mb'                                 |


## Unit Testing

- Unit tests are built using the [Node Test Runner](https://nodejs.org/api/test.html) and are triggered using `pnpm run test`

## Database

- This application implements a Postgres database based on the following [data model](../../docs/model/README.md) and managed by [Drizzle ORM](https://orm.drizzle.team/docs/overview)
- There is a known issue when using `pnpm drizzle-kit generate / pnpm drizzle-kit migrate` for future migrations. `generate` may work but `migrate` can throw an error that a given enum is already defined:  https://github.com/drizzle-team/drizzle-orm/issues/3206
  - The current work around is to run `pnpm drizzle-kit generate`, then use `pnpm drizzle-kit up` to update the Drizzle snapshots.
- A schema dbml (database markup language) file can be generated using the script `pnpm run dbml`. This file is found at `./src/db/schema.dbml`.
